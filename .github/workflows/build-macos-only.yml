name: Build macOS Only

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    timeout-minutes: 30
    env:
      CI: true
      DEBUG: electron-builder
      CSC_IDENTITY_AUTO_DISCOVERY: false
      CSC_LINK: ""
      CSC_KEY_PASSWORD: ""
      ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES: true
      APPLE_ID: ""
      APPLE_ID_PASSWORD: ""
      APPLE_TEAM_ID: ""
      # Additional macOS-specific variables
      CSC_IDENTITY: ""
      CSC_NAME: ""
      NOTARIZE: "false"
      SIGN: "false"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --omit=optional

      - name: Install platform-specific dependencies
        run: |
          npm install dmg-license --no-save
          # Ensure we have the necessary tools for DMG creation
          brew install create-dmg || echo "create-dmg already installed"

      - name: Run tests
        run: echo "Tests temporarily disabled - focusing on build artifacts"

      - name: Copy assets
        run: npm run copy-assets

      - name: Build Electron app
        run: |
          echo "Building for platform: mac"
          npm run build:mac
          echo "Build completed for mac"

      - name: List build outputs
        run: |
          echo "Contents of dist directory:"
          find dist -type f -name "*" 2>/dev/null || echo "No dist directory found"
          echo "All installer files in current directory:"
          find . -maxdepth 3 -type f -name "*.exe" -o -name "*.dmg" -o -name "*.AppImage" -o -name "*.deb" -o -name "*.zip" -o -name "*.tar.gz" 2>/dev/null || echo "No installer files found"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-mac
          path: |
            dist/**/*.zip
            dist/**/*.dmg
            dist/**/*.app
          retention-days: 30
          if-no-files-found: warn
