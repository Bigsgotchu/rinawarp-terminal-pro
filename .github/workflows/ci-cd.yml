name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: "18"

jobs:
  # Quality Gates - Must pass before builds
  lint:
    name: Lint Check
    uses: ./.github/workflows/lint.yml

  test:
    name: Test Suite  
    uses: ./.github/workflows/test.yml

  security:
    name: Security Audit
    uses: ./.github/workflows/security.yml

  # Build only after quality gates pass
  build-deploy:
    name: Build & Deploy
    needs: [lint, test, security]
    uses: ./.github/workflows/build-deploy.yml
    secrets: inherit

  # Report status
  ci-status:
    name: CI Status Report
    runs-on: ubuntu-latest
    needs: [lint, test, security, build-deploy]
    if: always()
    
    steps:
      - name: Check CI Results
        run: |
          echo "CI/CD Pipeline Results:"
          echo "Lint: ${{ needs.lint.result }}"
          echo "Test: ${{ needs.test.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Build & Deploy: ${{ needs.build-deploy.result }}"
          
          if [ "${{ needs.lint.result }}" != "success" ] || 
             [ "${{ needs.test.result }}" != "success" ] || 
             [ "${{ needs.security.result }}" != "success" ] || 
             [ "${{ needs.build-deploy.result }}" != "success" ]; then
            echo "::error::One or more CI/CD stages failed!"
            echo "::error::Please check the individual workflow runs for details."
            exit 1
          else
            echo "::notice::All CI/CD stages completed successfully! âœ…"
          fi
