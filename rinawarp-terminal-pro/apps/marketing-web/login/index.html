<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Login • RinaWarp</title>
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          base-uri 'self';
          object-src 'none';
          frame-ancestors 'none';
          img-src 'self' data:;
          style-src 'self' 'unsafe-inline';
          script-src 'self' 'unsafe-inline' https://static.cloudflareinsights.com;
          connect-src 'self' https://api.rinawarptech.com https://cloudflareinsights.com;
        " />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#0a0a0f; color:#fff; padding:24px; }
    .card { max-width:520px; margin:0 auto; background:#11121a; padding:20px; border-radius:16px; }
    input { width:100%; padding:12px; border-radius:10px; border:1px solid #2a2c3a; background:#0a0a0f; color:#fff; margin:8px 0; }
    button { width:100%; padding:12px; border-radius:10px; border:0; background:#ff3366; color:#fff; font-weight:700; cursor:pointer; }
    .muted { color:#b6b7c2; font-size:14px; }
    code { background:#0a0a0f; padding:2px 6px; border-radius:6px; }
    h1 { margin:0 0 8px 0; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Login</h1>
    <p class="muted">Log in to manage your license, regenerate download tokens, and verify your entitlement.</p>

    <div id="step1">
      <input id="email" placeholder="you@example.com" autocomplete="email"/>
      <button id="start">Send code</button>
      <p class="muted" id="startMsg"></p>
    </div>

    <div id="step2" style="display:none">
      <p class="muted">Check your email for the 6-digit code.</p>
      <input id="code" placeholder="123456" inputmode="numeric" maxlength="6"/>
      <button id="verify">Verify</button>
      <p class="muted" id="verifyMsg"></p>
    </div>

    <div id="step3" style="display:none">
      <h2>You're in ✅</h2>
      <p class="muted">Redirecting to your account…</p>
      <p><a href="/account/" style="color:#7dd3fc">Click here if you're not redirected</a></p>
    </div>

    <div style="margin-top:14px;font-size:13px;opacity:.85;">
      <span>New here?</span> <a href="/signup/" style="color:#6ad7ff;text-decoration:none;">Create an account</a>
    </div>
  </div>

<script>
const API = "https://api.rinawarptech.com";

// Sanitize redirect target to prevent open redirect vulnerabilities
function safeNext(rawNext) {
  if (!rawNext) return "/account/";
  // Reject absolute URLs and protocol-relative URLs
  if (rawNext.startsWith("http://") || rawNext.startsWith("https://") || rawNext.startsWith("//")) {
    return "/account/";
  }
  // Must start with "/"
  if (!rawNext.startsWith("/")) return "/account/";
  // Allowlist supported routes
  const allowedPrefixes = ["/account", "/download", "/success", "/login"];
  if (!allowedPrefixes.some((p) => rawNext.startsWith(p))) return "/account/";
  return rawNext;
}

// Extract token from URL path (e.g., /login/qzje/ → token=qzje)
function getTokenFromPath() {
  const path = window.location.pathname;
  // Match /login/<token>/ or /login/<token>
  const match = path.match(/^\/login\/([^\/]+)\/?$/);
  if (match && match[1] && match[1] !== "") {
    return match[1];
  }
  return "";
}

// Strip trailing slashes from token params
function cleanToken(token) {
  return (token || "").replace(/\/+$/, "");
}

let challengeId = null;

// Check for token in path (legacy format) and redirect to clean URL
(function normalizeUrl() {
  const tokenFromPath = getTokenFromPath();
  if (tokenFromPath && window.location.search.indexOf("token=") === -1) {
    // Token found in path but not in query - redirect to clean URL
    window.history.replaceState(null, "", `/login/?token=${encodeURIComponent(tokenFromPath)}`);
  }
})();

// Get token from query param
function getTokenFromUrl() {
  const params = new URLSearchParams(window.location.search);
  return cleanToken(params.get("token") || "");
}

document.getElementById("start").onclick = async () => {
  const email = document.getElementById("email").value.trim();
  const msg = document.getElementById("startMsg");
  msg.textContent = "Sending…";

  const res = await fetch(`${API}/api/auth/start`, {
    method: "POST",
    headers: {"content-type":"application/json"},
    body: JSON.stringify({ email })
  });

  const data = await res.json().catch(()=>({}));
  if (!res.ok) {
    msg.textContent = data.message || data.error || "Failed";
    return;
  }

  challengeId = data.challenge_id;
  msg.textContent = "Code sent. (If you don't see it, check spam.)";

  document.getElementById("step2").style.display = "block";
};

document.getElementById("verify").onclick = async () => {
  const code = document.getElementById("code").value.trim();
  const msg = document.getElementById("verifyMsg");
  msg.textContent = "Verifying…";

  const res = await fetch(`${API}/api/auth/verify`, {
    method: "POST",
    headers: {"content-type":"application/json"},
    body: JSON.stringify({ challenge_id: challengeId, code })
  });

  const data = await res.json().catch(()=>({}));
  if (!res.ok) {
    msg.textContent = data.error || "Invalid code";
    return;
  }

  localStorage.setItem("rw_session", data.session_token);
  document.getElementById("step1").style.display = "none";
  document.getElementById("step2").style.display = "none";
  document.getElementById("step3").style.display = "block";
  
  // Auto-redirect to next or account page
  setTimeout(() => {
    const params = new URLSearchParams(window.location.search);
    const next = safeNext(params.get("next") || "/account/");
    window.location.href = next;
  }, 1500);
};
</script>
</body>
</html>
