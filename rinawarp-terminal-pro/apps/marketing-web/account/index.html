<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Account — RinaWarp</title>
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 connect-src https://api.rinawarptech.com;
                 style-src 'self' 'unsafe-inline';
                 script-src 'self' 'unsafe-inline';
                 img-src 'self' data:;" />
  <style>
    :root{
      --bg:#0b0b10;
      --panel:rgba(255,255,255,.03);
      --border:rgba(255,255,255,.10);
      --text:#eaeaf0;
      --muted:rgba(234,234,240,.75);
      --pink:#ff3ea5;
      --coral:#ff6b6b;
      --teal:#19d3c5;
      --blue:#6ad7ff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--text)}
    a{color:var(--blue);text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:920px;margin:0 auto;padding:22px 18px 60px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:34px;height:34px;border-radius:10px;
      background:linear-gradient(135deg,var(--pink),var(--teal));
      display:flex;align-items:center;justify-content:center;font-weight:800;color:#0b0b10}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.02);color:var(--muted)}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{border:1px solid var(--border);border-radius:16px;background:var(--panel);padding:16px}
    h1{font-size:20px;margin:0}
    h2{font-size:14px;margin:0 0 10px;color:var(--muted);font-weight:650;letter-spacing:.2px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .btn{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.02);color:var(--text);cursor:pointer;font-weight:650}
    .btn.primary{border:0;color:#0b0b10;background:linear-gradient(90deg,var(--teal),var(--blue))}
    .btn.danger{border:0;color:#0b0b10;background:linear-gradient(90deg,var(--coral),var(--pink))}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:10px;margin-top:10px}
    .k{color:var(--muted);font-size:13px}
    .v{font-size:13px}
    .notice{margin-top:12px;font-size:13px;padding:10px 12px;border-radius:12px;border:1px solid var(--border)}
    .notice.ok{background:rgba(25,211,197,.10)}
    .notice.err{background:rgba(255,107,107,.12)}
    .downloads{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .dl{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.02)}
    .dl strong{font-size:13px}
    .dl span{font-size:12px;color:var(--muted)}
    .foot{margin-top:18px;color:var(--muted);font-size:12px}
    code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">R</div>
        <div>
          <h1>Account</h1>
          <div class="pill" id="buildPill">RinaWarp Terminal Pro • v1.0.0</div>
        </div>
      </div>
      <div class="row">
        <a class="pill" href="/download/">Downloads</a>
        <a class="pill" href="/support/">Support</a>
        <button class="btn danger" id="logoutBtn" onclick="logout()">Log out</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Your profile</h2>
        <div id="profile"></div>
        <div id="profileMsg"></div>
      </div>

      <div class="card">
        <h2>Downloads (tokened)</h2>
        <div class="downloads" id="downloads"></div>
        <div class="foot">
          Tokens expire automatically. If a download fails, click "Generate link" again.
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <h2>Billing</h2>
      <div class="row">
        <button class="btn primary" id="portalBtn" onclick="openPortal()">Open billing portal</button>
        <span class="pill">Secure redirect</span>
      </div>
      <div id="portalMsg"></div>
    </div>

    <div class="foot">
      Having trouble? Verify you're on <code>https://www.rinawarptech.com</code> and try again.
    </div>
  </div>

<script type="module">
  import { createApiClient } from "/assets/api-client.js";

  const api = createApiClient({ baseUrl: "https://api.rinawarptech.com" });

  const els = {
    profile: document.getElementById("profile"),
    profileMsg: document.getElementById("profileMsg"),
    downloads: document.getElementById("downloads"),
    portalMsg: document.getElementById("portalMsg"),
    portalBtn: document.getElementById("portalBtn"),
    logoutBtn: document.getElementById("logoutBtn")
  };

  function escapeHtml(s) {
    const d = document.createElement("div");
    d.textContent = String(s ?? "");
    return d.innerHTML;
  }

  function notice(targetEl, text, kind="ok") {
    targetEl.innerHTML = `<div class="notice ${kind}">${escapeHtml(text)}</div>`;
  }

  function requireAuthedOrBounce() {
    // If you use cookie session auth, /api/me will succeed when logged in.
    // If bearer tokens are used, wire storage later. v1 website: cookie is simplest.
  }

  async function loadMe() {
    els.profile.innerHTML = `<div class="pill">Loading…</div>`;
    els.downloads.innerHTML = `<div class="pill">Loading…</div>`;

    try {
      const me = await api.me();

      if (!me?.ok) {
        notice(els.profileMsg, `Not signed in (${me?.error || "unauthorized"}). Redirecting to login…`, "err");
        setTimeout(() => window.location.href = "/login/", 900);
        return;
      }

      const { user, license } = me;

      els.profile.innerHTML = `
        <div class="kv">
          <div class="k">Email</div><div class="v">${escapeHtml(user.email)}</div>
          <div class="k">User ID</div><div class="v"><code>${escapeHtml(user.id)}</code></div>
          <div class="k">Tier</div><div class="v"><span class="pill" style="border-color:rgba(25,211,197,.35);color:var(--teal)">${escapeHtml(license.tier)}</span></div>
          <div class="k">Status</div><div class="v">${escapeHtml(license.status)}</div>
          <div class="k">Expires</div><div class="v">${license.expiresAt ? escapeHtml(license.expiresAt) : "—"}</div>
        </div>
      `;

      renderDownloadCards(license.tier);
      notice(els.profileMsg, "Signed in successfully.", "ok");
    } catch (e) {
      notice(els.profileMsg, e?.message || "Failed to load account.", "err");
      els.profile.innerHTML = "";
      els.downloads.innerHTML = "";
    }
  }

  function renderDownloadCards(_tier) {
    const items = [
      { platform: "windows", label: "Windows (.exe)", version: "1.0.0" },
      { platform: "linux-appimage", label: "Linux (AppImage)", version: "1.0.0" },
      { platform: "linux-deb", label: "Linux (Debian/Ubuntu .deb)", version: "1.0.0" }
    ];

    els.downloads.innerHTML = items.map(x => `
      <div class="dl">
        <div>
          <strong>${escapeHtml(x.label)}</strong><br/>
          <span>RinaWarp Terminal Pro ${escapeHtml(x.version)}</span>
        </div>
        <button class="btn primary" onclick="window.__genDL('${x.platform}','${x.version}')">Generate link</button>
      </div>
    `).join("");
  }

  window.__genDL = async (platform, version) => {
    try {
      notice(els.portalMsg, "", "ok");
      const res = await fetch("https://api.rinawarptech.com/api/download-token", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ product: "terminal-pro", version, platform })
      }).then(r => r.json());

      if (!res?.ok) {
        notice(els.portalMsg, `Download token error: ${res?.error || "unknown"}`, "err");
        return;
      }

      const url = res.urls?.[platform];
      if (!url) {
        notice(els.portalMsg, "Token created, but no URL returned for that platform.", "err");
        return;
      }

      window.location.href = url;
    } catch (e) {
      notice(els.portalMsg, e?.message || "Failed to generate download link.", "err");
    }
  };

  window.openPortal = async () => {
    els.portalBtn.disabled = true;
    try {
      const res = await fetch("https://api.rinawarptech.com/api/portal", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({})
      }).then(r => r.json());

      if (!res?.ok || !res?.url) {
        notice(els.portalMsg, `Portal error: ${res?.error || "unknown"}`, "err");
        return;
      }
      window.location.href = res.url;
    } catch (e) {
      notice(els.portalMsg, e?.message || "Failed to open portal.", "err");
    } finally {
      els.portalBtn.disabled = false;
    }
  };

  window.logout = async () => {
    // v1: if using cookie sessions, implement /api/auth/logout later.
    // For now, best-effort: redirect to login and let session expire.
    window.location.href = "/login/";
  };

  requireAuthedOrBounce();
  await loadMe();
</script>
</body>
</html>
