<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RinaWarp Terminal - Working Version</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #1a1a1a;
            color: #fff;
            font-family: 'Consolas', 'Courier New', monospace;
            overflow: hidden;
        }
        
        .title-bar {
            height: 30px;
            background: #2d2d2d;
            border-bottom: 1px solid #444;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            -webkit-app-region: drag;
        }
        
        .title-bar-title {
            font-size: 13px;
            color: #fff;
        }
        
        .title-bar-controls {
            display: flex;
            gap: 8px;
            -webkit-app-region: no-drag;
        }
        
        .title-bar-control {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
        }
        
        .title-bar-control:nth-child(1) { background: #ff5f56; }
        .title-bar-control:nth-child(2) { background: #ffbd2e; }
        .title-bar-control:nth-child(3) { background: #27ca3f; }
        
        .terminal-container {
            width: 100vw;
            height: calc(100vh - 30px);
            background: #000;
            position: relative;
        }
        
        #terminal {
            width: 100%;
            height: 100%;
            padding: 10px;
            box-sizing: border-box;
        }
        
        .status-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 25px;
            background: #2d2d2d;
            border-top: 1px solid #444;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            font-size: 12px;
        }
        
        .status-left, .status-right {
            display: flex;
            gap: 15px;
        }
        
        .status-item {
            color: #aaa;
        }
        
        .status-item.success { color: #51cf66; }
        .status-item.warning { color: #ffd93d; }
        .status-item.error { color: #ff6b6b; }
    </style>
</head>
<body>
    <div class="title-bar">
        <div class="title-bar-title">RinaWarp Terminal - Working Version</div>
        <div class="title-bar-controls">
            <button class="title-bar-control" onclick="minimizeWindow()"></button>
            <button class="title-bar-control" onclick="maximizeWindow()"></button>
            <button class="title-bar-control" onclick="closeWindow()"></button>
        </div>
    </div>
    
    <div class="terminal-container">
        <div id="terminal"></div>
        <div class="status-bar">
            <div class="status-left">
                <span class="status-item" id="shell-status">Shell: Loading...</span>
                <span class="status-item" id="process-status">Process: Not started</span>
            </div>
            <div class="status-right">
                <span class="status-item" id="platform-info">Platform: Loading...</span>
                <span class="status-item success">RinaWarp v1.0.19</span>
            </div>
        </div>
    </div>

    <script>
        let terminal = null;
        let shellProcess = null;
        let isInitialized = false;

        // Window controls
        function minimizeWindow() {
            if (window.electronAPI) {
                console.log('Minimizing window...');
                // Try both methods
                window.electronAPI.minimizeWindow?.() || 
                window.electronAPI.ipcRenderer?.send('window-minimize');
            }
        }

        function maximizeWindow() {
            if (window.electronAPI) {
                console.log('Maximizing window...');
                window.electronAPI.maximizeWindow?.() || 
                window.electronAPI.ipcRenderer?.send('window-maximize');
            }
        }

        function closeWindow() {
            if (window.electronAPI) {
                console.log('Closing window...');
                window.electronAPI.closeWindow?.() || 
                window.electronAPI.ipcRenderer?.send('window-close');
            }
        }

        // Initialize working terminal
        async function initializeWorkingTerminal() {
            console.log('🚀 Initializing working terminal...');
            
            try {
                // Step 1: Load system info
                if (!window.electronAPI) {
                    throw new Error('Electron API not available');
                }
                
                const systemInfo = await window.electronAPI.getSystemInfo();
                document.getElementById('platform-info').textContent = `Platform: ${systemInfo.platform}`;
                document.getElementById('shell-status').textContent = `Shell: ${systemInfo.shell}`;
                console.log('✅ System info loaded:', systemInfo);
                
                // Step 2: Initialize XTerm
                console.log('📺 Loading XTerm...');
                await loadXTerm();
                
                // Step 3: Create shell process
                console.log('🐚 Creating shell process...');
                await createShellProcess(systemInfo);
                
                console.log('✅ Terminal initialization complete!');
                isInitialized = true;
                
            } catch (error) {
                console.error('❌ Terminal initialization failed:', error);
                showError(`Initialization failed: ${error.message}`);
            }
        }

        // Load XTerm with fallback
        async function loadXTerm() {
            try {
                // Try ES module import first
                const { Terminal } = await import('@xterm/xterm');
                const { FitAddon } = await import('@xterm/addon-fit');
                const { WebLinksAddon } = await import('@xterm/addon-web-links');
                
                // Create terminal
                terminal = new Terminal({
                    fontFamily: 'Consolas, "Courier New", monospace',
                    fontSize: 14,
                    lineHeight: 1.2,
                    cursorBlink: true,
                    cursorStyle: 'block',
                    theme: {
                        background: '#000000',
                        foreground: '#ffffff',
                        cursor: '#ffffff',
                        cursorAccent: '#000000',
                        selection: '#ffffff33',
                        black: '#2e3436',
                        red: '#cc0000',
                        green: '#4e9a06',
                        yellow: '#c4a000',
                        blue: '#3465a4',
                        magenta: '#75507b',
                        cyan: '#06989a',
                        white: '#d3d7cf',
                        brightBlack: '#555753',
                        brightRed: '#ef2929',
                        brightGreen: '#8ae234',
                        brightYellow: '#fce94f',
                        brightBlue: '#729fcf',
                        brightMagenta: '#ad7fa8',
                        brightCyan: '#34e2e2',
                        brightWhite: '#eeeeec'
                    }
                });

                // Add addons
                const fitAddon = new FitAddon();
                const webLinksAddon = new WebLinksAddon();
                
                terminal.loadAddon(fitAddon);
                terminal.loadAddon(webLinksAddon);

                // Open terminal
                terminal.open(document.getElementById('terminal'));
                fitAddon.fit();

                // Resize on window resize
                window.addEventListener('resize', () => {
                    fitAddon.fit();
                });

                // Welcome message
                terminal.writeln('🚀 RinaWarp Terminal - Working Version');
                terminal.writeln('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                terminal.writeln('✅ XTerm loaded successfully');
                
                console.log('✅ XTerm initialized successfully');
                return terminal;
                
            } catch (error) {
                console.warn('⚠️ XTerm ES modules failed, using fallback:', error.message);
                return createFallbackTerminal();
            }
        }

        // Create fallback terminal
        function createFallbackTerminal() {
            const terminalEl = document.getElementById('terminal');
            terminalEl.innerHTML = `
                <div style="padding: 20px; font-family: monospace; background: #000; color: #fff; height: 100%; box-sizing: border-box; overflow-y: auto;">
                    <div style="color: #ffd93d; margin-bottom: 10px;">⚠️ XTerm fallback mode active</div>
                    <div style="color: #74c0fc; margin-bottom: 20px;">Some features may be limited</div>
                    <div id="fallback-output" style="min-height: 200px; margin-bottom: 10px;"></div>
                    <div style="display: flex; align-items: center;">
                        <span style="color: #51cf66; margin-right: 8px;">$</span>
                        <input type="text" id="fallback-input" style="
                            background: transparent; 
                            border: none; 
                            color: #fff; 
                            font-family: monospace; 
                            font-size: 14px; 
                            outline: none; 
                            flex: 1;
                        " placeholder="Type commands here..." />
                    </div>
                </div>
            `;
            
            // Fallback terminal object
            terminal = {
                write: (data) => {
                    const output = document.getElementById('fallback-output');
                    if (output) {
                        output.innerHTML += data.replace(/\n/g, '<br>').replace(/\r/g, '');
                        output.scrollTop = output.scrollHeight;
                    }
                },
                writeln: (data) => {
                    const output = document.getElementById('fallback-output');
                    if (output) {
                        output.innerHTML += data + '<br>';
                        output.scrollTop = output.scrollHeight;
                    }
                },
                onData: (callback) => {
                    const input = document.getElementById('fallback-input');
                    if (input) {
                        input.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') {
                                const command = input.value;
                                input.value = '';
                                callback(command + '\r');
                            } else {
                                callback(e.key);
                            }
                        });
                    }
                },
                clear: () => {
                    const output = document.getElementById('fallback-output');
                    if (output) output.innerHTML = '';
                }
            };
            
            // Focus input
            setTimeout(() => {
                document.getElementById('fallback-input')?.focus();
            }, 100);
            
            console.log('📺 Fallback terminal created');
            return terminal;
        }

        // Create shell process
        async function createShellProcess(systemInfo) {
            try {
                const shellConfig = {
                    shell: systemInfo.shell,
                    shellArgs: systemInfo.platform === 'win32' ? ['-NoLogo', '-NoExit'] : [],
                    terminalId: 'main-terminal',
                    platform: systemInfo.platform
                };

                console.log('Creating shell with config:', shellConfig);
                
                shellProcess = await window.electronAPI.createShellProcess(shellConfig);
                
                if (!shellProcess) {
                    throw new Error('Shell process creation returned null');
                }
                
                console.log('✅ Shell process created:', shellProcess);
                document.getElementById('process-status').textContent = `Process: PID ${shellProcess.pid}`;
                document.getElementById('process-status').className = 'status-item success';
                
                // Set up shell event listeners
                window.electronAPI.onShellData(shellProcess.id, (data) => {
                    const output = data.toString();
                    console.log('📤 Shell output:', output.slice(0, 100) + (output.length > 100 ? '...' : ''));
                    if (terminal) {
                        terminal.write(output);
                    }
                });

                window.electronAPI.onShellError(shellProcess.id, (data) => {
                    const error = data.toString();
                    console.log('❌ Shell error:', error);
                    if (terminal) {
                        terminal.write(`\r\n[ERROR] ${error}\r\n`);
                    }
                });

                window.electronAPI.onShellExit(shellProcess.id, (code, signal) => {
                    console.log(`🔚 Shell exited with code ${code}, signal ${signal}`);
                    if (terminal) {
                        terminal.write(`\r\n[Process exited with code ${code}]\r\n`);
                    }
                    document.getElementById('process-status').textContent = `Process: Exited (${code})`;
                    document.getElementById('process-status').className = 'status-item warning';
                });

                // Handle terminal input
                terminal.onData((data) => {
                    console.log('📝 Sending to shell:', JSON.stringify(data.slice(0, 20)));
                    window.electronAPI.writeToShell(shellProcess.id, data);
                });

                // Send initial prompt
                setTimeout(() => {
                    terminal.writeln('✅ Shell process connected');
                    terminal.write('\r\n');
                }, 500);

            } catch (error) {
                console.error('❌ Shell process creation failed:', error);
                document.getElementById('process-status').textContent = `Process: Failed - ${error.message}`;
                document.getElementById('process-status').className = 'status-item error';
                
                if (terminal) {
                    terminal.write(`\r\n[Shell creation failed: ${error.message}]\r\n`);
                    terminal.write('Terminal is in offline mode. Shell commands will not work.\r\n');
                    terminal.write('$ ');
                }
            }
        }

        // Show error
        function showError(message) {
            const terminalEl = document.getElementById('terminal');
            terminalEl.innerHTML = `
                <div style="padding: 20px; color: #ff6b6b; font-family: monospace;">
                    <h2>❌ Terminal Error</h2>
                    <p>${message}</p>
                    <p style="color: #aaa; margin-top: 20px;">
                        Check the Developer Console (F12) for more details.
                    </p>
                    <button onclick="initializeWorkingTerminal()" style="
                        background: #51cf66;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 4px;
                        cursor: pointer;
                        margin-top: 15px;
                    ">
                        🔄 Retry Initialization
                    </button>
                </div>
            `;
        }

        // Initialize when DOM loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🌊 DOM loaded, starting terminal initialization...');
            
            // Small delay to ensure electron APIs are ready
            setTimeout(() => {
                initializeWorkingTerminal();
            }, 100);
        });

        // Global error handler
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            if (!isInitialized) {
                showError(`Startup error: ${event.error.message}`);
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl+Shift+I: Toggle DevTools
            if (e.ctrlKey && e.shiftKey && e.key === 'I') {
                e.preventDefault();
                console.log('DevTools shortcut triggered');
            }
            
            // Ctrl+R: Reload terminal
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                location.reload();
            }
        });

        console.log('🚀 Working terminal script loaded');
    </script>
</body>
</html>
